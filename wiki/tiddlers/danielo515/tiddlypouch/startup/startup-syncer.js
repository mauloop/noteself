/*\
title: $:/plugins/danielo515/tiddlypouch/startup/pouchdb-sycer.js
type: application/javascript
module-type: startup


@preserve

\*/
(function(){"use strict";exports.name="pouchdb-sycer";exports.after=["pouchdb"];exports.platforms=["browser"];exports.synchronous=true;var t="$:/state/tiddlypouch/sync/status";var e="$:/state/tiddlypouch/sync/Log";var n="$:/state/tiddlypouch/sync/Log";var r="$:/plugins/danielo515/tiddlypouch/config/";exports.startup=function(){var r=new $TPouch.Logger("PouchSync");function i(t,e,n){if($TPouch.config.debug.isActive()){var i=$tw.wiki.getTiddlerText(t)+"\n";if(typeof e==="object"){if(e.change&&e.change.docs){delete e.change.docs}var o=JSON.stringify(e,null,$tw.config.preferences.jsonSpaces)}else{var o=e}o=n?n+o:o;var c={type:"text/plain",text:i+o,title:t};$tw.wiki.addTiddler(new $tw.Tiddler(c))}r.log(e)}function o(r){return r.put(a()).then(o).catch(function(t){if(t.status==409){o()}else{i(e,t,"===SYNC Error starting===");return t}});function o(o){var c=$TPouch.database._db.sync(r,{live:true,retry:true,filter:"filtered_replication/only_tiddlers"}).on("change",function(t){i(n,t,"===SYNC Change===")}).on("paused",function(e){$tw.wiki.setText(t,"text",undefined,"paused");if(e)i(n,e,"===SYNC PAUSED===");else i(n,"===SYNC PAUSED===")}).on("active",function(){$tw.wiki.setText(t,"text",undefined,"syncing");i(n,"===SYNC ACTIVE===");i(n,"replicate resumed")}).on("denied",function(t){i(e,t,"===SYNC Denied===")}).on("complete",function(e){$tw.wiki.setText(t,"text",undefined,"completed");i(n,e,"===SYNC Completed===")}).on("error",function(n){$tw.wiki.setText(t,"text",undefined,"error");i(e,n,"===SYNC Error===")});$TPouch.database._db.put(a()).catch(function(t){if(t.status!==409){i(e,"Filtered replication may not work, we were unable to store the required doc on the local DB","===SYNC Error starting===")}});$TPouch.syncHandler=c}}function c(t){var e=$TPouch.config;var r=e.currentDB.getUrl();var o=e.currentDB.getRemoteName();if(!r){i(n,"Entering offline mode");$tw.rootWidget.dispatchEvent({type:"tp-sync-state",param:"offline"});return}$tw.rootWidget.dispatchEvent({type:"tp-sync-state",param:"online"});return new PouchDB(r+o,{auth:t})}function a(){return{_id:"_design/filtered_replication",filters:{only_tiddlers:function(t){return t.hasOwnProperty("fields")}.toString()}}}$TPouch.startSync=o;$TPouch.newOnlineDB=c}})();