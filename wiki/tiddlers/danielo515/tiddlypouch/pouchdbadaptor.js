/*\
title: $:/plugins/danielo515/tiddlypouch/pouchadaptor.js
type: application/javascript
module-type: syncadaptor

A sync adaptor module for synchronising with local PouchDB


@preserve

\*/
"use strict";function PouchAdaptor(t){this.wiki=t.wiki;var e=$TPouch.config.debug;this.logger=new $TPouch.Logger("PouchAdaptor",e.isActive(),e.isVerbose());this.sessionUrl=$TPouch.config.currentDB.getUrl("_session")}function httpRequest(t){var e=t.type||"GET",o=t.headers||{accept:"application/json"},n=new XMLHttpRequest,r="",i;if(t.data){if(typeof t.data==="string"){r=t.data}else{i=[];$tw.utils.each(t.data,function(t,e){i.push(e+"="+encodeURIComponent(t))});r=i.join("&")}}if(t.withCredentials){n.withCredentials=true}n.onreadystatechange=function(){if(this.readyState===4){if(this.status===200||this.status===201||this.status===204){t.callback(null,this.responseText,this);return}t.callback("XMLHttpRequest error code: "+this.status)}};n.open(e,t.url,true);if(o){$tw.utils.each(o,function(t,e,o){n.setRequestHeader(e,t)})}if(r&&!$tw.utils.hop(o,"Content-type")){n.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8")}n.send(r);return n}PouchAdaptor.prototype.getStatus=function(t){var e=this;if(!e.sessionUrl){return t(null,false,"NON-AUTHENTICATED")}httpRequest({url:e.sessionUrl,withCredentials:true,callback:function(o,n){if(o){return t(o)}var r=null;var i=false;var a=null;try{r=JSON.parse(n)}catch(s){}if(r&&r.userCtx){a=r.userCtx.name;i=a!==null;if(!i&&r.userCtx.roles.length==1&&r.userCtx.roles[0]==="_admin"){e.logger("Warning! Server is on admin party mode!");i=true}}if(i&&!$TPouch.onlineDB){e.login()}t(null,i,a)}})};PouchAdaptor.prototype.getTiddlerInfo=function(t){return{_rev:t.fields.revision}};PouchAdaptor.prototype.getSkinnyTiddlers=function(t){$TPouch.database.getSkinnyTiddlers().then(t.bind(null,null)).catch(t)};PouchAdaptor.prototype.saveTiddler=function(t,e,o){this.logger.trace("Tiddler info ",o.tiddlerInfo);$TPouch.router.route(t,o).addTiddler(t,o).then(function(t){e(null,{_rev:t.rev},t.rev)}).catch(e)};PouchAdaptor.prototype.loadTiddler=function(t,e){$TPouch.database.getTiddler(t).then(e.bind(null,null)).catch(e)};PouchAdaptor.prototype.deleteTiddler=function(t,e,o){if(!o.tiddlerInfo||!o.tiddlerInfo.adaptorInfo||typeof o.tiddlerInfo.adaptorInfo._rev=="undefined"){e(null)}$TPouch.database.deleteTiddler(t).then(e.bind(e,null)).catch(e)};PouchAdaptor.prototype.isReady=function(){return true};PouchAdaptor.prototype.login=function(t,e,o){var n=this;n.logger.log("Trying to sync...");var r=$TPouch.newOnlineDB({username:t,password:e});if(!r){n.logger.log("Warning, sync is not possible because no onlineDB");return o("There is no online DB set")}$TPouch.onlineDB=r;$TPouch.startSync(r).then(o)};PouchAdaptor.prototype.logout=function(t){var e=this;var o={url:e.sessionUrl,type:"DELETE",withCredentials:true,callback:function(e){t(e)}};httpRequest(o)};if($tw.browser&&$TPouch.database){exports.adaptorClass=PouchAdaptor}